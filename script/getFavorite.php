<?phprequire('../conf/const.conf.php');require('../lib/db.php');require_once( '../config.php' );require_once( '../saetv2.ex.class.php' );$db = new Db();$sql = "select token,email,lasttime from useremail,wbtoken where useremail.userid = wbtoken.userid";$res = $db->query($sql);while ($row = mysqli_fetch_row($res)) {    $token = $row[0];    $email = $row[1];    $lastTime = $row[2];    $c = new SaeTClientV2( WB_AKEY , WB_SKEY , $token );    $favorRes = $c->get_favorites(1,10);    $favor = $favorRes['favorites'];     $newTime = strtotime($favor[0]['favorited_time']);//    var_dump($newTime);        if($newTime <= $lastTime) {        sae_debug($email.'no result');         continue;    }        foreach($favor as $values) {        $createdTime = strtotime($values['favorited_time']);        sae_debug($values['status']['mid']);        sae_debug($createdTime);        if( $createdTime > $lastTime ) {            $id = $values['status']['mid'];            $uid = $values['status']['user']['id'];            if(isset($values['status']['retweeted_status'])){                $title = $values['status']['retweeted_status']['text'];            }else {                $title = $values['status']['text'];            }             $arrMid = $c->querymid($id);            $mid = $arrMid['mid'];            $url = sprintf("http://weibo.com/%s/%s",$uid,$mid);            $boolMail = setMail($title,$url,$email);            if($boolMail == true) {                sae_debug("send mail success".$title.$url);             } else {                sae_debug("send failed".$title.$url);             }            usleep(200);        }     }    $sql = "update useremail set lasttime=$newTime where email='$email' " ;    $db->query($sql);}function setMail( $title,$url,$mailAddr ) {    //    $tag = ' #@sttime #study ^today';    $mailTitle = escape($title);    $mailTitle = mb_substr($mailTitle,0,30,'utf8') . $tag;    $mailText = <<<EOF微博内容: $title微博url: $urlEOF;    $mail = new SaeMail();      $ret = $mail->quickSend( $mailAddr , $mailTitle , $mailText , EMAIL , PWD );    if ($ret === false){        sae_debug($mail->errno().$mail->errmsg());        return false;    }    //    sae_debug("title:".$mailTitle);    //    sae_debug("text:".$mailText);    return true;}function escape($str) {    $arrStr = array(        "《",        "》",        "'",        "‘",        "’",        "【",        "】",        "个",        "#",        "＃",    );    $replace = array('','','','','','','','','','');    return str_replace($arrStr,$replace,$str); }