<?phprequire('init.php');session_start();if(!isset($_POST['email']) || !isset($_SESSION['token'])) {    echo 'failed';    exit;}$token = $_SESSION['token']['access_token'];$email = $_POST['email'];if(strpos($email,"@") === false) {    $message = "对不起，您添加的email不合法";    $smarty->assign("message",$message);    $smarty->display("register.tpl");    exit;}$fetchUrl = new SaeFetchurl(); $url = "https://api.weibo.com/2/account/get_uid.json?access_token=$token";$content = $fetchUrl->fetch($url);$arrUid = json_decode($content,true);$wbid = $arrUid['uid'];$db = new Db();//judge if has the wbid $sql = "select userid from users where wbid=$wbid";$res = $db->query($sql);$row = mysqli_fetch_row($res);if(empty($row)) {    $sql = "insert into users (wbid) values ($wbid)";    var_dump($sql);    $res = $db->query($sql);    $id = $db->getLastInsertId();} else {    $id = $row[0];}//update token$sql = "insert into wbtoken (userid,token)values ($id,'$token') ON DUPLICATE KEY UPDATE token='$token'";$res = $db->query($sql);//update email$sql = "select email from useremail where userid=$id and email='$email'";$res = $db->query($sql);$row = mysqli_fetch_row($res);if(empty($row)) {    $sql = "insert into useremail (userid,email)values ($id,'$email')";//    var_dump($sql);    $res = $db->query($sql);    if($res != false) {        $message = "email添加成功";        $smarty->assign("message",$message);        $smarty->display("register.tpl");        exit;    }} else {    $message = '该email已添加过';    $smarty->assign("message",$message);    $smarty->display("register.tpl");    exit;}